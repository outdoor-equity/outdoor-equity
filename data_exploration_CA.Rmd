---
title: "Data Exploration - CA only"
author: "Clarissa Boyajian"
date: "1/17/2022"
output: html_document
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE)

library(tidyverse)
library(janitor)
library(gt)
library(sf)
library(tmap)

dir.create(here::here("data")) # download data from RIDB and put in this file
dir.create(here::here("data/california_data"))
```

```{r Load and split data, eval=FALSE}
# Load raw data for CA and choose columns to keep
raw_data <- read.csv("data/FY20_historical_reservations_full_raw.csv") %>% 
  filter(facilitystate == "California") %>% 
  select(agency, regioncode, regiondescription, parentlocation, park, sitetype, usetype, 
         inventorytype, facilityzip, facilitystate, facilitylongitude, 
         facilitylatitude, customerzip, customerstate, customercountry, 
         totalpaid, startdate, enddate, orderdate, nights, numberofpeople, 
         equipmentdescription)
```


```{r, eval=FALSE}
# Filter just rows with customer zip code
subset_customer_zip <- raw_data %>% filter(customerzip != "") %>% 
  mutate(latitude = as.numeric(facilitylatitude),
         longitude = as.numeric(facilitylongitude)) %>% 
  st_as_sf(coords = c("longitude", "latitude"),
           crs = 4326)

## Subset down for data exploration ##

# Filter out funky zip codes
subset_customer_zip_good <- 
  subset_customer_zip[nchar(as.character(subset_customer_zip$customerzip)) == 5, ]

# summarize by park
park_summary_df <- subset_customer_zip_good %>% 
  group_by(park) %>% 
  summarise(average_visitors = mean(numberofpeople),
            total_visitors = sum(numberofpeople),
            total_paid = mean(totalpaid))

# park lat/lon
park_locations_df <- subset_customer_zip_good %>% 
  group_by(park) %>% 
  summarise(latitude = mode(facilitylatitude),
            longitude = mode(facilitylongitude)) %>% 
  extract(geometry, into = c('lon', 'lat'), '\\((.*),(.*)\\)', conv = T) %>% 
  select(park, lat, lon) %>% 
  rename(latitude = lat,
         longitude = lon)


# Write to CSV
subset_customer_zip_good %>% 
  extract(geometry, into = c('lon', 'lat'), '\\((.*),(.*)\\)', conv = T) %>% 
  as.data.frame() %>% 
  select(!c(geometry)) %>% 
  rename(latitude = lat,
         longitude = lon) %>% 
  write.csv("data/california_data/california_customers_with_zipcode.csv")

write.csv(park_summary_df, "data/california_data/california_parks_summary.csv")

write.csv(park_locations_df, "data/california_data/california_park_locations.csv")
```


```{r}
subset_valid_customerzip <- read.csv("data/california_data/california_customers_with_zipcode.csv") %>% 
  mutate(latitude = as.numeric(latitude),
         longitude = as.numeric(longitude)) %>% 
  select(!c(X)) %>% 
  st_as_sf(coords = c("longitude", "latitude"),
           crs = 4326) %>% 
  mutate(agency = as.factor(agency))

# park_summary_df <- read.csv("data/california_data/california_parks_summary.csv")
# names(park_summary_df)[1:ncol(park_summary_df) - 1] <- names(park_summary_df)[2:ncol(park_summary_df)]
# 
# park_locations_df <- read.csv("data/california_data/california_park_locations.csv")
# names(park_locations_df)[1:ncol(park_locations_df) - 1] <- names(park_locations_df)[2:ncol(park_locations_df)]
```


```{r}
ggplot(subset_valid_customerzip) +
  geom_histogram(aes(x = agency), stat = "count")
```

```{r}
ca_county_geom <- st_read("data/map_data/counties.shp") %>% 
  clean_names() %>% 
  rename(county_name = name)

tm_shape(ca_county_geom) + 
  tm_fill(col = "white") +
  tm_borders(col = "black", alpha = 0.5) +
tm_shape(subset_valid_customerzip) + 
  tm_dots()
```



